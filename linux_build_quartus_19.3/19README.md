# 17.1 Setup

Converting programming file:

```sh
quartus_cpf -c --hps -o bitstream_compression=on output_files/ghrd_10as066n2.sof output_files/ghrd_10as066n2.rbf
```

Building Uboot
```sh
cd ~/a10_soc_devkit_ghrd/software/uboot_bsp
make
```


Run device Tree Generator
```sh
sopc2dts --input ghrd_10as066n2.sopcinfo --output ghrd_10as066n2.dts  --board hps_a10_common_board_info.xml --board hps_a10_devkit_board_info.xml --board ghrd_10as066n2_board_info.xml --bridge-removal all --clocks
```
Edit dts to add SPI device:


Run device Tree Compiler
```sh
dtc -I dts -O dtb -o socfpga_arria10_socdk_sdmmc.dtb ghrd_10as066n2.dts
```

#19.3 
## A. Setup
Create top folder:
```sh
mkdir ~/custom_20200225
cd ~/custom_20200225
export TOP_FOLDER=`pwd`
```
Start an Embedded Command Shell:
```sh
~/intelFPGA_pro/19.3/embedded/embedded_command_shell.sh
```
Bring a copy of the hardware design - already compiled namely:
- *.sopcinfo
- hps_isw_handoff
- output_files
```sh
cd $TOP_FOLDER
mkdir a10_soc_devkit_ghrd
cd a10_soc_devkit_ghrd

```

## B. Build U-Boot

Run bsp-create-settings with no user options to convert the handoff data into device tree file:
```sh
cd $TOP_FOLDER/a10_soc_devkit_ghrd/
mkdir -p software/bootloader
bsp-create-settings \
    --type uboot \
    --bsp-dir software/bootloader \
    --preloader-settings-dir "hps_isw_handoff" \
    --settings software/bootloader/settings.bsp
```
This creates the file software/bootloader/devicetree.dts

Manually remove the following pieces from the generated device tree file above:
```
/dts-v1/;
```
and
```
    chosen {
        cff-file = "socfpga.rbf";   /* Bootloader setting: uboot.rbf_filename */
        early-release-fpga-config;
    };
```
Retrieve the U-Boot source code by cloning the git tree, and checking out the supported branch:
```sh
cd $TOP_FOLDER/a10_soc_devkit_ghrd/software/bootloader
git clone https://github.com/altera-opensource/u-boot-socfpga
cd u-boot-socfpga
git checkout -b test -t origin/socfpga_v2019.04
```
Copy the device tree generated by the bsp-create-settings into U-Boot:
```sh
cd $TOP_FOLDER/a10_soc_devkit_ghrd/software/bootloader/u-boot-socfpga
cp ../devicetree.dts arch/arm/dts/socfpga_arria10_socdk_sdmmc_handoff.dtsi
```
Configure and build U-Boot:
```sh
cd $TOP_FOLDER/a10_soc_devkit_ghrd/software/bootloader/u-boot-socfpga
export ARCH=arm
export CROSS_COMPILE=arm-eabi-
make socfpga_arria10_defconfig
make -j 24
```
This will create the following files:
File     Description
spl/u-boot-spl-dtb.bin  SPL binary
u-boot.img  U-Boot image

Create the bootable SPL image containing four identical SPL binaries, with the header required by BootROM:
```sh
cd $TOP_FOLDER/a10_soc_devkit_ghrd/software/bootloader/u-boot-socfpga
mkpimage -hv 1 -o spl/spl_w_dtb-mkpimage.bin \
   spl/u-boot-spl-dtb.bin spl/u-boot-spl-dtb.bin \
   spl/u-boot-spl-dtb.bin spl/u-boot-spl-dtb.bin
```
This creates the file spl/spl_w_dtb-mkpimage.bin.

Create the FIT image with the FPGA programming files, used by SPL to configure FPGA:
```sh
cd $TOP_FOLDER/a10_soc_devkit_ghrd/software/bootloader/u-boot-socfpga
cp ../../../output_files/ghrd_10as066n2.core.rbf .
cp ../../../output_files/ghrd_10as066n2.periph.rbf .
tools/mkimage -E -f board/altera/arria10-socdk/fit_spl_fpga.its fit_spl_fpga.itb
```
This creates the file fit_spl_fpga.itb.

## C. Prepare SD Card Image

Create SD card folder and retrieve the SD card script:

```sh
cd $TOP_FOLDER/
sudo rm -rf sd_card && mkdir sd_card && cd sd_card
wget https://releases.rocketboards.org/release/2018.10/gsrd/tools/make_sdimage.py
chmod +x make_sdimage.py
```
Create the folder for the FAT partition and gather the files:

```sh
cd $TOP_FOLDER/sd_card
mkdir sdfs &&  cd sdfs
cp <directory for linux build>/zImage .
cp <directory for linux build>/socfpga_arria10_socdk_sdmmc.dtb .
cp ../../a10_soc_devkit_ghrd/software/bootloader/u-boot-socfpga/fit_spl_fpga.itb .
cp ../../a10_soc_devkit_ghrd/software/bootloader/u-boot-socfpga/u-boot.img .
mkdir extlinux
echo "LABEL Arria10 SOCDK SDMMC" > extlinux/extlinux.conf
echo "    KERNEL ../zImage" >> extlinux/extlinux.conf
echo "    FDT ../socfpga_arria10_socdk_sdmmc.dtb" >> extlinux/extlinux.conf
echo "    APPEND root=/dev/mmcblk0p2 rw rootwait earlyprintk console=ttyS0,115200n8" >> extlinux/extlinux.conf
```
Create the folder for the rootfs partition:
```sh
cd $TOP_FOLDER/sd_card
mkdir rootfs && cd rootfs
sudo tar xf $LINUX_BIN/core-image-minimal-arria10.tar.gz
sudo rm -rf lib/modules/*
```
Bring over the SPL binary:
```sh
cd $TOP_FOLDER/sd_card
cp ../a10_soc_devkit_ghrd/software/bootloader/u-boot-socfpga/spl/spl_w_dtb-mkpimage.bin .
```
Create the SD card image:
Usually this command does not run correctly in Ubuntu 16.04 or 18.04, so you can run it on Centos 6.6.
To build the image you only need the ```sd_card``` folder.
```sh
cd $TOP_FOLDER/sd_card
sudo ./make_sdimage.py -f \
-P spl_w_dtb-mkpimage.bin,num=3,format=raw,size=10M,type=A2  \
-P sdfs/*,num=1,format=vfat,size=100M \
-P rootfs/*,num=2,format=ext3,size=300M \
-s 512M \
-n sdcard_a10.img
```
sopc2dts --input qsys_top.sopcinfo --output ghrd_10as066n2.dts  --board hps_a10_common_board_info.xml --board hps_a10_devkit_board_info.xml --board qsys_top_board_info.xml --bridge-removal all --clocks
